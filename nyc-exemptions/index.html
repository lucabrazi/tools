<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- No inline scripts now; we can drop 'unsafe-inline' from script-src -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://data.cityofnewyork.us https://cdn.jsdelivr.net;
                 style-src   'self' 'unsafe-inline' https://cdn.jsdelivr.net;
                 script-src  'self';
                 img-src     'self' data:;
                 font-src    'self' https://cdn.jsdelivr.net data:;
                 connect-src https://data.cityofnewyork.us;
                 base-uri    'self';
                 form-action 'self'">
  <title>NYC Property Exemption Lookup</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="d-flex justify-content-between align-items-start mb-3">
    <h1 class="me-3">Cfix NYC Property Exemption Lookup Tool</h1>
    <div id="share-banner" class="alert alert-success py-1 px-2 d-none d-print-none small" role="alert" style="white-space: nowrap;"></div>
  </div>

  <div id="input-form">
    <h3 class="me-3"><br>Search By Borough, Block and Lot</h3>
    <form class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="borough" class="form-label">Borough</label>
          <select id="borough" class="form-select">
            <option value="">-- Select Borough --</option>
            <option value="1">1 - Manhattan</option>
            <option value="2">2 - Bronx</option>
            <option value="3">3 - Brooklyn</option>
            <option value="4">4 - Queens</option>
            <option value="5">5 - Staten Island</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="block" class="form-label">Block</label>
          <input type="text" id="block" class="form-control" placeholder="e.g. 5777" />
        </div>
        <div class="col-md-3">
          <label for="lot" class="form-label">Lot</label>
          <input type="text" id="lot" class="form-control" placeholder="e.g. 1020" />
        </div>
        <div class="col-md-2 d-grid">
          <button type="button" id="searchBBL" class="btn btn-secondary">Search</button>
        </div>
        <br>&nbsp;
      </div>

      <hr class="my-4" />

      <h3 class="me-3"><br>Search By 10 Digit Parcel ID (BBL)</h3>
      <div class="row g-3 align-items-end">
        <div class="col-md-10">
          <label for="parid" class="form-label">Parcel ID</label>
          <input type="text" id="parid" class="form-control" placeholder="e.g. 2057771020" />
        </div>
        <div class="col-md-2 d-grid">
          <button type="button" id="searchParid" class="btn btn-secondary">Search</button>
        </div>
      </div>
    </form>
  </div>

  <div id="action-buttons" class="mb-3 d-none d-print-none">
    <div class="d-flex flex-wrap flex-md-nowrap gap-2 align-items-start">
      <button class="btn btn-secondary" id="newSearchBtn">
        <i class="bi bi-arrow-left-circle me-1"></i> New Search
      </button>
      <button class="btn btn-success" id="downloadCsv">
        <i class="bi bi-file-earmark-arrow-down me-1"></i> Download CSV*
      </button>
      <button class="btn btn-outline-secondary" id="share">
        <i class="bi bi-link-45deg me-1"></i> Copy Shareable Link
      </button>
      <button class="btn btn-outline-primary" id="printBtn">
        <i class="bi bi-printer me-1"></i> Print
      </button>
    </div>
  </div>

  <div id="property-details" class="mb-4"></div>
  <div id="summary"></div>
  <div id="year-nav" class="d-print-none"></div>
  <div id="results"></div>

  <div id="print-share-link" class="d-none d-print-block mt-4">
    <h5>Link to Most Recent Report For This Property:</h5>
    <p class="small text-muted">
      <a id="print-url" href="#" target="_blank" style="word-break: break-all;"></a>
    </p>
  </div>

  <div id="disclaimer-sources">
    <hr class="my-4">
    <h5>Data Disclaimer & Sources</h5>
    <p class="small text-muted">
      The information presented in this report is sourced directly from the
      <a href="https://data.cityofnewyork.us/resource/64uk-42ks" target="_blank">Primary Land Use Tax Lot Output (PLUTO)</a>,
      the NYC
      <a href="https://data.cityofnewyork.us/Housing-Development-and-Preservation/Property-Exemptions/muvi-b6kx" target="_blank">NYC Department of Housing Preservation & Development (HPD)</a>, and
      <a href="https://data.cityofnewyork.us/Housing-Development-and-Preservation/Exemption-Code-Lookup/myn9-hwsy" target="_blank">NYC Open Data</a>
      portals. These datasets reflect HPD-administered tax exemptions and related benefits granted to eligible properties.
    </p>
    <p class="small text-muted">
      The dataset used for this tool begins with assessment year <strong>2021</strong>. Records prior to this year are not included and may not be available through the current public data feed.
    </p>
    <p class="small text-muted">
      While this tool provides a convenient interface to explore HPD exemption data, users are encouraged to verify property-specific details directly with the
      <a href="https://www.nyc.gov/html/hpd/html/home/home.shtml" target="_blank">NYC Department of Housing Preservation & Development</a>
      or consult a qualified real estate professional for investment, compliance, or legal decisions.
    </p>
    <p class="small text-muted">
      We make no representations or warranties, expressed or implied, as to the accuracy of this information. References to square footage, age or any other metrics are approximate.
      You bear all risk for any reliance you place on this information. In no event will we be liable for any loss or damage including without limitation, indirect or consequential loss
      or damage arising out of, or in connection with your use of, or inability to use, this website. Through this website you are able to link to other websites which are not under the
      control of team.lalacre.com. We do not necessarily recommend or endorse the views expressed within them, and we have no control over their content. This website is controlled and
      operated by teamlalacre.com. We work hard and continuously to keep the website up and running without a glitch. However, due to technical issues within or beyond our control
      sometimes the site will be down or not working properly. Let us know and we will do our best to resolve any problems. Thank you for visiting our site.
    </p>
  </div>

  <div id="loadingOverlay" class="d-none">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-2">Loadingâ€¦</div>
  </div>

  <!-- Diagnostics -->
  <div id="diag" class="d-print-none" style="display:none; margin-top:16px;">
    <div class="card border-secondary mb-3">
      <div class="card-header py-2">Diagnostics</div>
      <div class="card-body small font-monospace lh-sm">
        <div><strong>Origin:</strong> <span id="d-origin"></span></div>
        <div><strong>Token present:</strong> <span id="d-token"></span></div>
        <div><strong>Last URL:</strong> <span id="d-url" style="overflow-wrap:anywhere;"></span></div>
        <div><strong>Status:</strong> <span id="d-status"></span></div>
        <div><strong>429 backoff used:</strong> <span id="d-rl"></span></div>
        <div><strong>Retries:</strong> <span id="d-retries"></span></div>
        <div><strong>Time:</strong> <span id="d-time"></span></div>
      </div>
    </div>

    <div class="card border-secondary mb-3">
      <div class="card-header py-2">Source Links</div>
      <div class="card-body small font-monospace lh-sm">
        <pre id="d-csv-header" style="white-space:pre-wrap; overflow-wrap:anywhere;">!!! Run a search to see sources.</pre>
      </div>
    </div>
  </div>

  <div class="d-print-none" style="margin-top:8px;">
    <button id="toggleDiag" class="btn btn-sm btn-outline-secondary">Show Diagnostics &amp; Sources</button>
  </div>

  <!-- Load the app (ES module) -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
